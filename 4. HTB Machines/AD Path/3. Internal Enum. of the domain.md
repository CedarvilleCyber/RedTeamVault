
Key data points:
![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXc9hltjvvel2xQdhpxG68TgsHDE1yAAiGSSEYfLz_9jt1LWPoq8ED6epPfyXcLNPYeIGCSDp5d9s84bl82NwW-SuRuWIlkvECVRydvIdGHXJtoDs2ZYoILkuPSSgmM1k83m6QtX9g?key=iaFFVFGI6Bfpg5YW3a1suQ)

==Login to target (MICROSOFT):== `xfreerdp /v:<MS01 target IP> /u:htb-student /p:Academy_student_AD!`

==Login to target (LINUX)==: `ssh htb-student@<ATTACK01 target IP>`
HTB_@cademy_stdnt!

## Passive Methods:
1. Use Wireshark/Tcpdump to monitor for ==arp== or ==MDNS== traffic
	1. Who is talking to who?
	- `sudo -E wireshark` (filter on 'arp' and 'mdns')
	- `sudo tcpdump -i ens224 `
2. `sudo responder -I ens224 -A`

## Active Methods:
1. fping: scriptable tool that works in round robin fashion that can lead to greater speeds.
	- `fping -asgq 172.16.5.0/23`
	![[Pasted image 20250528230237.png]]
2. Nmap:
	- `sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum`

==172.16.5.5== -> ACADEMY-EA-DC01


1. Identify users
	-  Kerbrute: Takes advantage of pre-authentication weakness
	- `kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users`

mmorgan has no preauth required:
![[Pasted image 20250528231818.png]]

==By gaining SYSTEM-level access on a domain-joined host, you will be able to perform actions such as, but not limited to:==
- Enumerate the domain using built-in tools or offensive tools such as BloodHound and PowerView.
- Perform Kerberoasting / ASREPRoasting attacks within the same domain.
- Run tools such as Inveigh to gather Net-NTLMv2 hashes or perform SMB relay attacks.
- Perform token impersonation to hijack a privileged domain user account.
- Carry out ACL attacks.

# LLMNR/NBT-NS Poisoning - from Linux

- LLMNR and NBT-NS are used when DNS fails for hosts to perform name resolution.
- NBT-NS: UDP 137
- LLMNR: UDP 5355
- ^^ When these are used on the network Any host can reply.
    
- If a host tries to broadcast over these protocols, responder can capture the NetNTLM hashes that can be cracked offline.
- ==How this happens== 
- If someone is on the network and attempts to connect to a print server and commits a typo, DNS will say “I don’t have that printer” and then the host will broadcast with these protocols and responder will reply and capture the NetNTLM hash.
    

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXeEpPtpcWO7Sbf3cCPvKWYyoqBn2HdbGeJRtdR5u5X7OeTjeg2HQo_XnYR4FtBuPOYNu4oVNH_y3X7kEimDNTR8VpGbDFHaURqw1cM-fFS-Y8mFUJCC2AqlA3QAIk2xvH3iqwJ-3g?key=iaFFVFGI6Bfpg5YW3a1suQ)

  

`responder -I eth0 -wrf`:

- -w: Start the WPAD proxy (Fake that you are a proxy to Windows browser)
- -r: Enable answers for netbios wredir suffix queries.
- -f: Fingerprint remote host and operating system
- 
    
- Output saved to: /usr/share/responder/logs
- NetNTLM hashes are not able to be used in pass the hash attacks, they must be cracked offline
    

### Cracking NTLMv2 hashes with hashcat:  
`hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt`

Credentials gathered: FOREND:Klmcargo2

^^ Keep hashcat running in the background, but make sure that you do not spend too much time cracking hashes that will be of no value to you overall.


## LLMNR/NBT-NS Poisoning - from Windows

### Inveigh Powershell:
- Similar to responder, but is written in Powershell and C#
- ==To get help==: `get-help invoke-inveigh -examples`
- ==Start Inveigh==: `Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y`
### Inveigh C#:
- Run `.\Inveigh.exe`
- Press `esc` to enter the console
![[Pasted image 20250529231439.png]]

^^ ==Get NTLMv2UNIQUE== is very useful

==Usernames below==
![[Pasted image 20250529231744.png]]

- To get rid of NBT-NS on your domain, You can write a powershell script, Create a GPO on the domain controller, add it to a share, and then call it via its UNC path.
- You can also just filter/block the LLMR/NetBIOS traffic

==Crack an NTLMv2 Hash with Hashcat==:
`hashcat -m 5600 -a 0 svc_qualys_hash.txt /usr/share/wordlists/rockyou.txt`

Creds: SVC_QUALYS:security#1
#### Detection:
- If a response to LLMR/NetBIOS is recieved from a non-existent host, we know something is up

### What we can do with the info we have now:
1. Hosts (Ports open)
2. Usernames 
3. one password
4. user hashes

- We can now use Bloodhound
- Crack hashes offline
- Password spray

## Password Spraying Overview:

- There is limited time in a penetration test, so you must do things in parrallel.

**Linkedin2Usernames + jsmith wordlist** = Good username list
^^ Then use Kerbrute to enumerate usernames

==Be careful to not lockout accounts!== Where can you find the password policy?

1. If you do not know the password policy, wait a few hours between attempts.

## Enumerating the Password Policy:
1. With valid creds, the password policy can be obtained with [[RPCclient]] or [[CrackMapExec]]
	1. `crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`
2. To enumerate the password policy *without* creds, attempt to use an **SMB-null** session or an LDAP anonymous bind.
	1. To enumerate an SMB Null session, use [[Enum4Linux]], [[CrackMapExec]] or [[RPCclient]]
	2. `rpcclient -U "" -N 172.16.5.5`
		1. `querydomaininfo`
		2. `getdomainpwinfo`


#### Windows Password Policy Enumeration:

1. What if you can't transport tools to a windows machine? -> Use ==net==!
![[Pasted image 20250530144614.png]]

From this we can deduce:
1. Passwords never expire
2. Minimum password length is 8 (Meaning there will be weak passwords)
3. We can try 2-3 passwords every 31 minutes and never have fear of being locked out

