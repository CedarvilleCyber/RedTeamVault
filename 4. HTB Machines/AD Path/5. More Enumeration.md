>After gaining a foothold, we could use this access to get a feeling for the defensive state of the hosts, enumerate the domain further now that our visibility is not as restricted, and, if necessary, work at "living off the land" by using tools that exist natively on the hosts.


## Microsoft Defender:
- Will block things like `PowerView`
	- To get around this, the built in PowerShell cmdlet `Get-MpComputerStatus` can be used to see if the `RealTimeProtectionEnabled` parameter is set to `True`
## AppLocker:
- Whitelist used by system admins
	- An example of this would be blocking `PowerShell.exe`, but PowerShell is not only in one location, so attackers can sometimes get around this.
- ==To get AppLocker policies==:
```powershell-session
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
## PowerShell Contrained Language Mode:
- Locks down many of the features used to run PowerShell effectively
==To enumerate PowerShell Language Mode==
```powershell-session
$ExecutionContext.SessionState.LanguageMode

ConstrainedLanguage
```

## LAPS:
- Local Administrator Password Solution
- Passwords are unique to each machine and rotated regularly. They can be stored on-prem or in the cloud. LAPS can help mitigate:
	1. Pass the hash attacks 
	2. Lateral movement in general

Attackers can use several cmdlets to enumerate users who are a part of LAPS -> to target their attacks.

These CmdLets include:
1. `Find-AdmPwdExtendedRights`
2. `Find-LAPSDelegatedGroups`
3. `Get-LAPSComputers`


# Credentialed Enumeration - From Linux:
-> It is time to enumerate the domain in depth
==Use credentials:== forend:Klmcargo2

CME offers a help menu for each protocol (i.e., `crackmapexec winrm -h`, etc.). Be sure to review the entire help menu and all possible options. For now, the flags we are interested in are:

- -u Username `The user whose credentials we will use to authenticate`
- -p Password `User's password`
- Target (IP or FQDN) `Target host to enumerate` (in our case, the Domain Controller)
- --users `Specifies to enumerate Domain Users`
- --groups `Specifies to enumerate domain groups`
- --loggedon-users `Attempts to enumerate what users are logged on to a target, if any`

==Command ran== `crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares --sessions --loggedon-users --groups`

![[Pasted image 20250601155752.png]]

==Get all the users==
![[Pasted image 20250601160203.png]]

==Spidering shares==

```shell-session
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```

==Try to get LAPS passwords (with LDAP)==
`crackmapexec ldap 172.16.5.5 -u forend -p Klmcargo2 -M laps`

## rpcclient:

**RID**: unique identifier to track identity objects. it is used to tell a user apart on the domain. The big key is that **Domain admins** have an RID of 512 and the **Default Administrator** account has an RID of 500

## Impacket:
Impacket is a versatile toolkit that provides us with many different ways to enumerate, interact, and exploit Windows protocols and find the information we need using Python.

Psexec.py is a clone of the Sysinternals psexec executable, but works slightly differently from the original. The tool creates a remote service by uploading a randomly-named executable to the `ADMIN$` share on the target host. It then registers the service via `RPC` and the `Windows Service Control Manager`. Once established, communication happens over a named pipe, providing an interactive remote shell as `SYSTEM` on the victim host.


## Wmiexec.py:

More stealthy, and runs as local admin as opposed to SYSTEM. A dead giveaway it is being used is the event ID `4688: A new process has been created`. Because every time you execute a command with WMI, it spawns a shell

#### Nested Group Memberships:
- The practice of adding one group as a member of another. 
- This makes assigning groups much easier, but offers less control to administrators to creating a security concern


<<<<<<< HEAD
## Bloodhound:
- One of the best tools to enumerate AD relationships in a domain
-> Bloodhound-python: Linux
-> Sharphound.exe: Windows
=======
## Enumeration from Windows:

How do we get a greater view of the domain and
- What file shares can we pillage?

#### Active Directory Powershell module:
>>>>>>> origin/Lamoreaux/Additions
